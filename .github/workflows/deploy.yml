# ============================================================
#  CI/CD Pipeline – DevNotes FastAPI
#  Author: Markam | Role: DevOps/Backend Engineer
# ------------------------------------------------------------
#  Pipeline Overview:
#   1️⃣ Lint & build FastAPI app using Docker
#   2️⃣ Spin up PostgreSQL test service
#   3️⃣ Verify DB connection & container health
#   4️⃣ Deploy to Render (auto-trigger via API)
# ============================================================

name: CI/CD Pipeline - DevNotes FastAPI

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "README.md"
      - "test.py"
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - "README.md"
      - "test.py"

jobs:
  test_build:
    name: Build & Test Backend
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: devnotes_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      EXTERNAL_DB_URL_FOR_TEST: postgresql://postgres:postgres@localhost:5432/devnotes_test
      PYTHONUNBUFFERED: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint codebase
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Test DB connection
        run: |
          python - <<'PYCODE'
          import psycopg2, os, time
          for i in range(10):
              try:
                  conn = psycopg2.connect(os.getenv("EXTERNAL_DB_URL_FOR_TEST"))
                  print("✅ Database connection successful")
                  conn.close()
                  break
              except Exception as e:
                  print("DB not ready yet:", e)
                  time.sleep(3)
          else:
              raise SystemExit("❌ Database test failed")
          PYCODE

      - name: Build Docker image
        run: docker build -t devnotes-test .

      - name: Run container health check
        run: |
          docker run -d -p 8000:8000 --name devnotes devnotes-test
          sleep 10
          curl -f http://localhost:8000/health || (docker logs devnotes && exit 1)
          docker stop devnotes

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: test_build
    if: success() && !contains(github.event.head_commit.message, 'skip deploy')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_DEVNOTES }}
        run: |
          echo " Deploying to Render..."
          response=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -d "{\"serviceId\": \"$RENDER_SERVICE_ID\"}" \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys)
          [ "$response" = "201" ] && echo "✅ Deploy triggered" || (cat /tmp/response.json && exit 1)

      - name: Send email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ DevNotes Deploy Failed"
          to: "rundailytest@gmail.com"
          from: "GitHub CI <no-reply@devnotes.ci>"
          body: |
            Render deployment failed.
            Repo: ${{ github.repository }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
