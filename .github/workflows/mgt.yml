name: Manage Devnote Project

on:
  push:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:

  # -----------------------------
  # 1. Python Code Checks
  # -----------------------------
  python_checks:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install -r requirements.txt

      - name: Run Python checks
        run: |
          set +e
          pytest test_devnote.py --maxfail=1 --disable-warnings --cov=.
          RESULT=$?
          if [ $RESULT -eq 0 ]; then echo "Python checks passed"; else echo "Python checks failed"; fi
          exit $RESULT

      - name: Set job status
        id: set_status
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "::set-output name=result::success"
          else
            echo "::set-output name=result::failure"
          fi

  # -----------------------------
  # 2. Dependency & Security Scan
  # -----------------------------
  dependency_scan:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: pip install pip-audit

      - name: Run pip-audit
        run: pip-audit || exit 1

      - name: Set job status
        id: set_status
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "::set-output name=result::success"
          else
            echo "::set-output name=result::failure"
          fi



# -----------------------------
# 3. Docker Build + API Test
# -----------------------------
  docker_build_test:
    runs-on: ubuntu-latest
    needs: python_checks
    outputs:
      status: ${{ steps.set_status.outputs.result }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: devnotes_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t devnotes-test .

      - name: Run API container
        run: |
          docker run -d -p 8000:8000 --name devnotes \
            --add-host=host.docker.internal:host-gateway \
            --env DATABASE_URL=postgresql://postgres:postgres@host.docker.internal:5432/devnotes_db \
            devnotes-test

          # Container may take longer to come up
          for i in {1..30}; do
            if curl -s -f http://localhost:8000/health; then
              echo "FastAPI is up"
              break
            fi
            echo "Waiting for FastAPI..."
            sleep 2
          done

      - name: Health check
        run: curl -f http://localhost:8000/health || exit 1

      - name: API CRUD test
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"title":"Test","content":"CI/CD test"}' \
            http://localhost:8000/notes || exit 1

          curl -f http://localhost:8000/notes || exit 1
          curl -f http://localhost:8000/stats || exit 1

      - name: Save container logs
        if: failure()
        run: docker logs devnotes > /tmp/devnotes.log

      - name: Upload container logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: devnotes-logs
          path: /tmp/devnotes.log

      - name: Stop container
        run: |
          docker stop devnotes
          docker rm devnotes

      - name: Set job status
        id: set_status
        run: |
          if [ "${{ job.status }}" == 'success' ]; then
            echo "::set-output name=result::success"
          else
            echo "::set-output name=result::failure"
          fi


  # -----------------------------
  # 4. App Health Monitoring
  # -----------------------------
  url_monitor:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set_status.outputs.result }}
    steps:
      - name: Check Production URL
        run: |
          if curl "${{ secrets.RENDER_LIVE_URL }}/health"; then
            exit 0
          else
            exit 1
          fi

      - name: Set job status
        id: set_status
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "::set-output name=result::success"
          else
            echo "::set-output name=result::failure"
          fi

  # -----------------------------
  # 5. Deployment Trigger
  # -----------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: python_checks
    if: needs.python_checks.outputs.status == 'success'
    outputs:
      status: ${{ steps.set_status.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Trigger Render deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID_DEVNOTES }}
        run: |
          response=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -d "{\"serviceId\": \"$RENDER_SERVICE_ID\"}" \
            https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys)

          echo "$response" > /tmp/response_code.txt

          if [ "$response" = "202" ] || [ "$response" = "201" ]; then
            echo "Deploy triggered Successfuly"
          else
            echo "Deploy failed with status: $response."
            exit 1
          fi

      - name: Upload Render response artifacts
        if: failure() || success()
        uses: actions/upload-artifact@v4
        with:
          name: render-response
          path: |
            /tmp/response.json
            /tmp/response_code.txt

      - name: Set job status
        id: set_status
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "::set-output name=result::success"
          else
            echo "::set-output name=result::failure"
          fi

  # -----------------------------
  # 6. Daily Summary Email
  # -----------------------------
  daily_summary:
    runs-on: ubuntu-latest
    needs:
      - python_checks
      - dependency_scan
      - docker_build_test
      - url_monitor
      - deploy
    steps:
      - name: Generate summary table
        run: |
          SUMMARY="Pipeline Summary for $(date -u)\n\n"
          SUMMARY+="| Job | Status |\n"
          SUMMARY+="|-----|--------|\n"
          SUMMARY+="| Python Checks     | ${{ needs.python_checks.outputs.status }} |\n"
          SUMMARY+="| Dependency Scan   | ${{ needs.dependency_scan.outputs.status }} |\n"
          SUMMARY+="| Docker + API Test | ${{ needs.docker_build_test.outputs.status }} |\n"
          SUMMARY+="| URL Monitor       | ${{ needs.url_monitor.outputs.status }} |\n"
          SUMMARY+="| Deploy            | ${{ needs.deploy.outputs.status }} |\n"
          echo -e "$SUMMARY" > summary.txt
          cat summary.txt

      - name: Send summary email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ðŸ“Š Daily DevNotes Pipeline Summary"
          to: ${{ secrets.RECEIVER_MAIL }}
          from: "GitHub CI <no-reply@devnotes.ci>"
          body: |
            $(cat summary.txt)

